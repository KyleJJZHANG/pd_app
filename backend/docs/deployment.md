# 心理鸭后端部署指南

## 1. 部署架构概述

心理鸭后端采用容器化部署方案，支持开发、测试和生产环境的一致性部署。整体架构包括应用服务、数据库、缓存、负载均衡和监控等组件。

### 1.1 部署环境分层

- **开发环境**: 本地开发和测试
- **测试环境**: CI/CD 自动化测试
- **预发布环境**: 生产前验证
- **生产环境**: 正式服务环境

### 1.2 核心组件

- **应用服务**: FastAPI + CrewAI 智能体系统
- **数据库**: PostgreSQL（主）+ SQLite（开发）
- **缓存**: Redis
- **负载均衡**: Nginx
- **监控**: Prometheus + Grafana
- **日志**: ELK Stack
- **容器编排**: Docker Compose / Kubernetes

## 2. 容器化配置

### 2.1 Docker 镜像构建

应用采用多阶段构建，优化镜像大小和安全性：

- **Base Image**: Python 3.11 slim
- **Dependencies**: 预安装依赖包
- **Application**: 复制应用代码
- **Runtime**: 非 root 用户运行

### 2.2 环境变量管理

所有配置通过环境变量管理，支持不同环境的配置隔离：

- **数据库连接**: DATABASE_URL
- **LLM API**: OPENAI_API_KEY, ANTHROPIC_API_KEY
- **缓存配置**: REDIS_URL
- **应用配置**: DEBUG, LOG_LEVEL
- **安全配置**: SECRET_KEY, ALLOWED_ORIGINS

### 2.3 数据持久化

- **数据库数据**: 持久化卷挂载
- **日志文件**: 日志目录挂载
- **内容资源**: 静态文件目录挂载
- **配置文件**: ConfigMap 挂载

## 3. 开发环境部署

### 3.1 快速启动

使用 Docker Compose 一键启动完整开发环境：

```bash
# 克隆项目
git clone <repository-url>
cd duck-therapy-backend

# 配置环境变量
cp .env.example .env
# 编辑 .env 文件设置必要参数

# 启动服务
docker-compose up -d

# 验证服务
curl http://localhost:8000/health
```

### 3.2 服务组件

- **backend**: 主应用服务 (端口 8000)
- **postgres**: 数据库服务 (端口 5432)
- **redis**: 缓存服务 (端口 6379)
- **nginx**: 反向代理 (端口 80)

### 3.3 开发工具

- **热重载**: 代码变更自动重启
- **调试模式**: 详细错误信息
- **API 文档**: http://localhost:8000/docs
- **数据库管理**: pgAdmin 或命令行工具

## 4. 生产环境部署

### 4.1 基础设施要求

**最小配置**:
- CPU: 2 核心
- 内存: 4GB
- 存储: 50GB SSD
- 网络: 100Mbps

**推荐配置**:
- CPU: 4 核心
- 内存: 8GB
- 存储: 100GB SSD
- 网络: 1Gbps

### 4.2 高可用部署

**应用层**:
- 多实例部署
- 负载均衡分发
- 健康检查自动恢复

**数据层**:
- 数据库主从复制
- Redis 集群模式
- 定期数据备份

**网络层**:
- CDN 加速静态资源
- SSL/TLS 加密传输
- DDoS 防护

### 4.3 扩展性设计

**水平扩展**:
- 应用服务无状态设计
- 数据库读写分离
- 缓存分布式部署

**垂直扩展**:
- 资源监控和告警
- 自动扩容策略
- 性能瓶颈识别

## 5. CI/CD 流水线

### 5.1 代码质量检查

- **静态分析**: Pylint, Black 代码格式检查
- **安全扫描**: 依赖漏洞扫描
- **单元测试**: pytest 自动化测试
- **覆盖率检查**: 代码覆盖率要求

### 5.2 构建和发布

**构建阶段**:
- Docker 镜像构建
- 镜像安全扫描
- 制品仓库推送
- 版本标签管理

**部署阶段**:
- 蓝绿部署策略
- 滚动更新机制
- 自动回滚功能
- 部署状态通知

### 5.3 环境管理

- **开发分支**: 自动部署到测试环境
- **主分支**: 部署到预发布环境
- **标签版本**: 部署到生产环境
- **热修复**: 紧急修复流程

## 6. 数据库部署和管理

### 6.1 数据库选择

**开发环境**: SQLite
- 轻量级，易于调试
- 无需额外配置
- 适合单人开发

**生产环境**: PostgreSQL
- 高性能和可靠性
- 支持复杂查询
- 完善的备份恢复

### 6.2 数据迁移

**初始化脚本**:
- 表结构创建
- 基础数据导入
- 索引和约束设置
- 权限配置

**版本管理**:
- Alembic 数据库迁移工具
- 版本化的迁移脚本
- 前向和后向兼容
- 迁移状态跟踪

### 6.3 备份策略

**定期备份**:
- 每日全量备份
- 每小时增量备份
- 异地备份存储
- 备份完整性验证

**恢复流程**:
- 快速恢复程序
- 数据一致性检查
- 恢复测试演练
- 灾难恢复预案

## 7. 安全配置

### 7.1 网络安全

**访问控制**:
- 防火墙规则配置
- VPN 内网访问
- API 访问限制
- IP 白名单机制

**传输安全**:
- HTTPS 强制跳转
- TLS 1.3 加密
- 证书自动更新
- HSTS 头部设置

### 7.2 应用安全

**身份认证**:
- JWT Token 机制
- 会话管理
- 密码策略
- 多因素认证

**数据保护**:
- 敏感数据加密
- 日志脱敏处理
- 数据访问审计
- 隐私合规检查

### 7.3 容器安全

**镜像安全**:
- 基础镜像定期更新
- 漏洞扫描检查
- 最小权限原则
- 非 root 用户运行

**运行时安全**:
- 容器资源限制
- 网络隔离配置
- 文件系统只读
- 安全上下文设置

## 8. 监控和告警

### 8.1 应用监控

**性能指标**:
- API 响应时间
- 请求成功率
- 智能体处理时间
- 系统资源使用率

**业务指标**:
- 用户活跃度
- 对话质量评分
- 功能使用统计
- 错误发生频率

### 8.2 基础设施监控

**服务器监控**:
- CPU、内存、磁盘
- 网络流量和延迟
- 服务可用性检查
- 日志错误统计

**数据库监控**:
- 连接数和查询性能
- 锁等待和死锁
- 备份状态检查
- 存储空间使用

### 8.3 告警策略

**告警级别**:
- **P0 紧急**: 服务完全不可用
- **P1 高级**: 核心功能受影响
- **P2 中级**: 部分功能异常
- **P3 低级**: 性能下降或警告

**通知渠道**:
- 短信通知（紧急）
- 邮件通知（常规）
- 即时消息（团队群）
- 监控大屏显示

## 9. 运维流程

### 9.1 发布流程

**发布前检查**:
- 代码审查完成
- 测试用例通过
- 性能测试验证
- 安全扫描通过

**发布执行**:
- 维护时间窗口
- 数据库迁移
- 应用更新部署
- 功能验证测试

**发布后验证**:
- 服务健康检查
- 关键功能测试
- 监控指标确认
- 用户反馈收集

### 9.2 故障处理

**故障响应**:
- 告警接收和确认
- 问题影响评估
- 应急处理措施
- 根因分析调查

**恢复流程**:
- 临时解决方案
- 服务快速恢复
- 数据一致性检查
- 用户沟通通知

### 9.3 日常维护

**定期任务**:
- 日志清理和归档
- 数据库优化维护
- 安全更新安装
- 备份恢复验证

**容量规划**:
- 资源使用趋势分析
- 性能瓶颈识别
- 扩容需求评估
- 成本优化建议

## 10. 性能优化

### 10.1 应用层优化

**代码优化**:
- 异步处理机制
- 连接池管理
- 缓存策略优化
- 资源回收管理

**智能体优化**:
- 模型响应时间优化
- 批处理请求合并
- 预计算结果缓存
- 负载均衡分发

### 10.2 数据层优化

**数据库优化**:
- 索引策略优化
- 查询语句调优
- 分库分表设计
- 读写分离配置

**缓存优化**:
- 缓存键设计
- 过期策略配置
- 缓存穿透防护
- 热点数据预热

### 10.3 网络层优化

**CDN 配置**:
- 静态资源加速
- 智能路由选择
- 缓存策略配置
- 压缩传输优化

**负载均衡**:
- 健康检查配置
- 会话保持策略
- 流量分发算法
- 故障转移机制

## 11. 成本管理

### 11.1 资源优化

**计算资源**:
- 按需扩缩容
- 预留实例优化
- 闲时资源回收
- 多云成本对比

**存储成本**:
- 数据生命周期管理
- 冷热数据分层
- 压缩和去重
- 备份策略优化

### 11.2 运营成本

**人力成本**:
- 自动化运维减少人工
- 标准化流程提升效率
- 监控告警减少故障
- 文档化知识传承

**第三方服务**:
- LLM API 使用优化
- 监控服务成本控制
- 备份存储成本优化
- 网络传输成本分析

## 12. 灾难恢复

### 12.1 备份策略

**数据备份**:
- 多地域备份存储
- 实时数据同步
- 定期恢复演练
- 备份完整性验证

**配置备份**:
- 基础设施即代码
- 配置版本管理
- 部署脚本备份
- 密钥安全存储

### 12.2 恢复计划

**RTO/RPO 目标**:
- 恢复时间目标: 4 小时
- 恢复点目标: 1 小时
- 数据丢失容忍度
- 服务降级策略

**应急预案**:
- 故障场景分类
- 恢复步骤清单
- 责任人员分工
- 沟通流程机制

这个部署指南为不同环境和需求提供了完整的部署方案，确保系统能够稳定、安全、高效地运行。